name: PR Audit

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    name: Code Review (Correctness/Effect/Security)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: '--allowed-tools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"'
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ## Code Review — Accounting Library

            This is `@autonomynexus/accounting`, a standalone TypeScript library for French accounting built with **Effect.ts**. It covers PCG, FEC, BNC 2035, liasse fiscale, VAT, URSSAF, financial statements, amortization. No database — pure computation library with Effect services and ports pattern.

            Review this PR for correctness, Effect patterns, and security.

            ### Accounting Correctness (Critical)

            - **Tax/accounting calculations** — verify formulas match French tax law (CGI, BOI)
            - **Rounding** — monetary values must use proper rounding rules
            - **Off-by-one errors** in date ranges, fiscal periods, thresholds
            - **Threshold logic** — check boundary conditions (<=, <, >=, >)
            - **FEC compliance** — ISO 8859-15 encoding, 18 mandatory fields, DGFiP format
            - **PCG account codes** — verify they match Plan Comptable Général
            - **Rate tables** — URSSAF rates, IS brackets, TVA rates must be current

            ### Effect.ts Patterns

            - Services use `Effect.Tag` (not Effect.Service)
            - Use `Effect.gen` for sequencing, not nested flatMaps
            - Errors are typed — use specific error types, not generic Error
            - Ports pattern — data access via port interfaces, not direct imports
            - No `Effect.runSync` or `Effect.runPromise` in library code (consumers run effects)
            - Use `Effect.fn` for traced functions where appropriate

            ### Security & Quality

            - No `any` types or `as any` casts
            - No hardcoded secrets
            - Input validation on public API functions
            - Edge cases handled (zero amounts, empty arrays, boundary dates)
            - Pure functions — no side effects in computation functions

            ### Output Rules

            - ONLY report issues that need fixing
            - Do NOT list things that are correct
            - Do NOT praise code or list what passed
            - Pay special attention to tax calculation accuracy

            Use `gh pr comment` to post findings. Format:

            ```markdown
            ## Code Review

            [For each issue:]
            ### [CRITICAL|HIGH|MEDIUM|LOW]: Brief description
            **File**: path:line
            **Issue**: What's wrong
            **Fix**: How to fix

            [Or if clean:]
            No issues found.
            ```
